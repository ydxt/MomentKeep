# 拾光记开发文档

## 1. 开发环境配置

### 1.1 系统要求

- **操作系统**：Windows 7+, macOS 10.14+, Linux (Ubuntu 18.04+)
- **Flutter SDK**：3.0.0 或更高版本
- **Dart SDK**：2.17.0 或更高版本
- **IDE**：Android Studio / VS Code（推荐安装 Flutter 插件）

### 1.2 环境搭建步骤

#### 1.2.1 安装 Flutter

```bash
# 下载 Flutter SDK
# Windows: https://flutter.dev/docs/get-started/install/windows
# macOS: https://flutter.dev/docs/get-started/install/macos
# Linux: https://flutter.dev/docs/get-started/install/linux

# 配置环境变量
# Windows: 将 Flutter 添加到 PATH
# macOS/Linux: export PATH="$PATH:`pwd`/flutter/bin"

# 验证安装
flutter doctor
```

#### 1.2.2 配置开发工具

**Android Studio**:
1. 安装 Android Studio
2. 安装 Flutter 和 Dart 插件
3. 配置 Android SDK

**VS Code**:
1. 安装 VS Code
2. 安装 Flutter 扩展
3. 安装 Dart 扩展

#### 1.2.3 克隆项目

```bash
git clone https://github.com/ydxt/momentkeep.git
cd momentkeep
```

#### 1.2.4 安装依赖

```bash
flutter pub get
```

#### 1.2.5 运行项目

```bash
# 移动端
flutter run

# Web 端
flutter run -d chrome

# Windows
flutter run -d windows

# macOS
flutter run -d macos

# Linux
flutter run -d linux
```

## 2. 项目结构详解

### 2.1 整体目录结构

```
momentkeep/
├── android/              # Android 平台代码
├── ios/                  # iOS 平台代码
├── web/                  # Web 平台代码
├── windows/              # Windows 平台代码
├── macos/                # macOS 平台代码
├── linux/                # Linux 平台代码
├── lib/                  # 核心代码
│   ├── main.dart         # 应用入口
│   ├── core/             # 核心层
│   │   ├── config/       # 配置
│   │   ├── services/     # 核心服务
│   │   ├── theme/        # 主题
│   │   └── utils/        # 工具类
│   ├── domain/           # 领域层
│   │   ├── entities/     # 实体
│   │   ├── repositories/ # 仓储
│   │   └── usecases/     # 用例
│   ├── presentation/     # 表现层
│   │   ├── blocs/        # BLoC
│   │   ├── pages/        # 页面
│   │   └── components/   # 组件
│   └── services/         # 数据服务
├── assets/               # 静态资源
├── docs/                 # 文档
├── test/                 # 测试
└── pubspec.yaml          # 依赖配置
```

### 2.2 核心层 (lib/core/)

#### 2.2.1 配置 (config/)

**app_config.dart** - 应用全局配置

```dart
class AppConfig {
  static const String appName = '拾光记';
  static const String appVersion = '1.0.0';
  static const String defaultLanguage = 'zh_CN';

  // 数据库配置
  static const String databaseName = 'momentkeep.db';
  static const int databaseVersion = 1;

  // 存储配置
  static const int maxCacheSize = 100 * 1024 * 1024; // 100MB

  // 备份配置
  static const int backupRetentionDays = 30;
}
```

#### 2.2.2 服务 (services/)

**audio_service.dart** - 音频服务

**storage_service.dart** - 存储服务

**notification_service.dart** - 通知服务

**location_service.dart** - 位置服务

**backup_service.dart** - 备份服务

**auto_cleanup_service.dart** - 自动清理服务

#### 2.2.3 主题 (theme/)

**app_theme.dart** - 主题定义

```dart
class AppTheme {
  static ThemeData get lightTheme => ThemeData(
    useMaterial3: true,
    brightness: Brightness.light,
    primaryColor: Colors.blue,
    // ... 更多主题配置
  );

  static ThemeData get darkTheme => ThemeData(
    useMaterial3: true,
    brightness: Brightness.dark,
    primaryColor: Colors.blue,
    // ... 更多主题配置
  );
}
```

**theme_provider.dart** - 主题状态管理

#### 2.2.4 工具类 (utils/)

**encryption_helper.dart** - 加密工具

**biometric_helper.dart** - 生物识别工具

**image_helper.dart** - 图片处理工具

**id_generator.dart** - ID 生成工具

### 2.3 领域层 (lib/domain/)

#### 2.3.1 实体 (entities/)

**todo.dart** - 待办事项实体

**habit.dart** - 习惯实体

**diary.dart** - 日记实体

**pomodoro.dart** - 番茄钟实体

**achievement.dart** - 成就实体

**check_in_record.dart** - 打卡记录实体

### 2.4 表现层 (lib/presentation/)

#### 2.4.1 BLoC (blocs/)

**habit_bloc.dart** - 习惯状态管理

**todo_bloc.dart** - 待办事项状态管理

**diary_bloc.dart** - 日记状态管理

**pomodoro_bloc.dart** - 番茄钟状态管理

**dashboard_bloc.dart** - 数据统计状态管理

#### 2.4.2 页面 (pages/)

**home_page.dart** - 首页

**habit_page.dart** - 习惯页面

**todo_page.dart** - 待办事项页面

**diary_page.dart** - 日记页面

**pomodoro_page.dart** - 番茄钟页面

**dashboard_page.dart** - 数据统计页面

**user_info_page.dart** - 用户信息页面

#### 2.4.3 组件 (components/)

**habit_checkin_bottom_sheet.dart** - 习惯打卡底部弹窗

**todo_editor_widget.dart** - 待办事项编辑器

**rich_text_editor.dart** - 富文本编辑器

**responsive_navigation.dart** - 响应式导航组件

### 2.5 数据服务层 (lib/services/)

**database_service.dart** - 数据库基础服务

**user_database_service.dart** - 用户数据库服务

**habit_database_service.dart** - 习惯数据库服务

**todo_database_service.dart** - 待办事项数据库服务

**diary_database_service.dart** - 日记数据库服务

**pomodoro_database_service.dart** - 番茄钟数据库服务

## 3. 开发规范

### 3.1 代码规范

#### 3.1.1 命名规范

- **类名**：大驼峰命名法（PascalCase）
  ```dart
  class TodoBloc extends Bloc<TodoEvent, TodoState> {}
  ```

- **变量名**：小驼峰命名法（camelCase）
  ```dart
  final String userName;
  final List<Todo> todoList;
  ```

- **常量名**：小写下划线命名法（lower_case_with_underscores）
  ```dart
  static const String databaseName = 'momentkeep.db';
  ```

- **私有成员**：前缀下划线
  ```dart
  String _privateVariable;
  void _privateMethod() {}
  ```

- **文件名**：小写下划线命名法（lower_case_with_underscores）
  ```
  todo_bloc.dart
  database_service.dart
  ```

#### 3.1.2 代码格式

```dart
// 使用 dart format 格式化代码
flutter format .

// 或者使用 IDE 自动格式化
// VS Code: Shift + Alt + F
// Android Studio: Ctrl + Alt + L
```

#### 3.1.3 注释规范

**文件头注释**：
```dart
/// 待办事项 BLoC
///
/// 负责管理待办事项的状态，包括加载、添加、更新、删除等操作
library;
```

**类注释**：
```dart
/// 待办事项状态管理
///
/// 使用 BLoC 模式管理待办事项的状态
class TodoBloc extends Bloc<TodoEvent, TodoState> {
  // ...
}
```

**函数注释**：
```dart
/// 创建待办事项
///
/// [todo] - 待办事项对象
/// @returns 创建的待办事项 ID
Future<int> createTodo(Todo todo) async {
  // ...
}
```

**行内注释**：
```dart
// 检查待办事项是否存在
if (existingTodo != null) {
  throw TodoAlreadyExistsException();
}
```

### 3.2 Git 提交规范

#### 3.2.1 提交信息格式

```
<type>: <subject>

<body>

<footer>
```

#### 3.2.2 Type 类型

- `feat`: 新功能
- `fix`: 修复 bug
- `docs`: 文档更新
- `style`: 代码格式调整
- `refactor`: 重构
- `test`: 测试相关
- `chore`: 构建/工具相关

#### 3.2.3 提交示例

```
feat: 添加习惯打卡功能

- 实现习惯创建和编辑
- 实现打卡功能
- 实现打卡历史记录

Closes #123
```

### 3.3 代码审查清单

- [ ] 代码符合命名规范
- [ ] 代码格式正确
- [ ] 添加了必要的注释
- [ ] 函数有完整的注释（功能、参数、返回值）
- [ ] 异常处理完善
- [ ] 没有硬编码的值
- [ ] 没有重复代码
- [ ] 通过了代码检查（flutter analyze）

## 4. 开发流程

### 4.1 功能开发流程

```mermaid
graph LR
    A[需求分析] --> B[设计接口]
    B --> C[实现实体]
    C --> D[实现服务]
    D --> E[实现 BLoC]
    E --> F[实现 UI]
    F --> G[编写测试]
    G --> H[代码审查]
    H --> I[合并代码]
```

### 4.2 分支管理

- `master` - 主分支，稳定版本
- `develop` - 开发分支
- `feature/*` - 功能分支
- `bugfix/*` - 修复分支

### 4.3 开发步骤

#### 4.3.1 创建功能分支

```bash
git checkout develop
git pull origin develop
git checkout -b feature/habit-checkin
```

#### 4.3.2 开发功能

1. 编写代码
2. 运行测试：`flutter test`
3. 代码检查：`flutter analyze`
4. 格式化代码：`flutter format .`

#### 4.3.3 提交代码

```bash
git add .
git commit -m "feat: 添加习惯打卡功能"
git push origin feature/habit-checkin
```

#### 4.3.4 创建 Pull Request

1. 在 GitHub 上创建 PR
2. 填写 PR 描述
3. 等待代码审查
4. 根据反馈修改代码
5. 合并到 develop

## 5. 调试技巧

### 5.1 日志输出

```dart
import 'package:logger/logger.dart';

final Logger logger = Logger();

logger.i('Info message');
logger.w('Warning message');
logger.e('Error message');
```

### 5.2 调试模式

```dart
// 在 main.dart 中启用调试模式
void main() {
  WidgetsFlutterBinding.ensureInitialized();
  runApp(MyApp());
}

// 使用 kDebugMode
if (kDebugMode) {
  print('Debug info');
}
```

### 5.3 性能分析

```bash
# 运行性能分析
flutter run --profile

# 生成性能报告
flutter drive --profile
```

### 5.4 热重载和热重启

```bash
# 热重载（保留状态）
r

# 热重启（重置状态）
R
```

## 6. 测试

### 6.1 单元测试

```dart
// test/services/todo_database_service_test.dart

void main() {
  group('TodoDatabaseService', () {
    late TodoDatabaseService service;

    setUp(() {
      service = TodoDatabaseService();
    });

    test('should create todo', () async {
      final todo = Todo(title: 'Test Todo');
      final id = await service.createTodo(todo);
      expect(id, greaterThan(0));
    });

    tearDown(() async {
      await service.close();
    });
  });
}
```

### 6.2 Widget 测试

```dart
// test/pages/todo_page_test.dart

void main() {
  testWidgets('TodoPage displays todos', (tester) async {
    await tester.pumpWidget(MyApp());
    expect(find.text('待办事项'), findsOneWidget);
  });
}
```

### 6.3 运行测试

```bash
# 运行所有测试
flutter test

# 运行特定测试文件
flutter test test/services/todo_database_service_test.dart

# 生成覆盖率报告
flutter test --coverage
```

## 7. 常见问题

### 7.1 依赖冲突

```bash
# 清理并重新安装依赖
flutter clean
flutter pub get
```

### 7.2 构建失败

```bash
# 清理构建缓存
flutter clean
flutter pub get
flutter run
```

### 7.3 平台特定问题

**Android**:
- 检查 `android/app/build.gradle` 配置
- 检查 `AndroidManifest.xml` 权限配置

**iOS**:
- 检查 `ios/Podfile` 配置
- 运行 `pod install`

**Web**:
- 检查浏览器兼容性
- 清理浏览器缓存

## 8. 性能优化

### 8.1 性能优化建议

1. **使用 const 构造函数**
   ```dart
   const Text('Hello');
   ```

2. **避免不必要的重建**
   ```dart
   class MyWidget extends StatelessWidget {
     @override
     Widget build(BuildContext context) {
       return const Text('Hello');
     }
   }
   ```

3. **使用 ListView.builder 而不是 ListView**
   ```dart
   ListView.builder(
     itemCount: items.length,
     itemBuilder: (context, index) {
       return ListTile(title: Text(items[index]));
     },
   );
   ```

4. **图片优化**
   ```dart
   // 使用缓存图片
   CachedNetworkImage(imageUrl: url);

   // 压缩图片
   await FlutterImageCompress.compressWithFile(
     file.path,
     quality: 85,
   );
   ```

5. **数据库查询优化**
   ```dart
   // 使用索引
   CREATE INDEX idx_todo_due_date ON todos(due_date);

   // 分页查询
   query('todos', limit: 20, offset: 0);
   ```

## 9. 发布流程

### 9.1 构建应用

```bash
# Android APK
flutter build apk --release

# Android App Bundle
flutter build appbundle --release

# iOS
flutter build ios --release

# Web
flutter build web --release

# Windows
flutter build windows --release

# macOS
flutter build macos --release

# Linux
flutter build linux --release
```

### 9.2 版本发布流程

1. 更新版本号（pubspec.yaml）
2. 更新 CHANGELOG
3. 运行测试
4. 构建应用
5. 上传到应用商店
6. 发布更新日志

## 10. 资源链接

- [Flutter 官方文档](https://flutter.dev/docs)
- [Dart 语言文档](https://dart.dev/guides)
- [BLoC 文档](https://bloclibrary.dev)
- [Flutter 包仓库](https://pub.dev)

---

**最后更新**：2026-02-02
**文档版本**：1.0.0
